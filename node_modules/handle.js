"use strict";
var fs = require("fs");
var _ = require('underscore');
module.exports = {
    execute: function(str,root,req,res){
        var belong = "$[placeholder]";
        var h = /\$belong\[["\s]*([^"\s]+)["\s]*\]/.exec(str);
        try{
            if(h){  //如果有belong关键字, 先处理: 所有路径关键字均使用从root起的绝对路径。
                belong = fs.readFileSync( root + "/" + h[1],'utf-8');   //读取belong文本
                str = str.replace(h[0], "" );           //替换关键字
                str = belong.replace("$[placeholder]",str);
            }
            str = str.replace(/\$include\[["\s]*([^"\s]+)["\s]*\]/g, function(match, key){
                return fs.readFileSync( root + "/" + key,'utf-8');   //读取include文本
            });
        }catch(e){
            res.writeHead(500, {"Content-Type": "text/html"});
            res.end( e.stack.toString().replace(/\n/g,"<br>") );
            return str;
        }
        var compiled = _.template(str);
        return compiled({request: req, response: res, require: require});
    }
};